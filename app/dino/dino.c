#include <bsp.h>
#include <dino.h>
#include <image.h>

static const uint8_t dino_image_data[][24 * 24 / 8] = {
    {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFB, 0xFF, 0xFF,
        0xBF, 0xBF, 0xBF, 0x3F, 0x3E, 0x00, 0x00, 0x00,
        0x00, 0x3F, 0x7C, 0xF8, 0xF0, 0xF0, 0xF8, 0xFC,
        0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x04,
        0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x3F, 0x2F,
        0x07, 0x03, 0x07, 0x3F, 0x21, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    },
    {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xFE, 0xFF, 0xE3, 0xEB, 0x63,
        0x7F, 0x7F, 0x7F, 0x3F, 0x3E, 0x00, 0x00, 0x00,
        0x00, 0x3F, 0x7C, 0xF8, 0xF0, 0xF0, 0xF8, 0xFC,
        0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x04,
        0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x3F, 0x2F,
        0x07, 0x03, 0x07, 0x3F, 0x21, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    },
    {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFB, 0xFF, 0xFF,
        0xBF, 0xBF, 0xBF, 0x3F, 0x3E, 0x00, 0x00, 0x00,
        0x00, 0x3F, 0x7C, 0xF8, 0xF0, 0xF0, 0xF8, 0xFC,
        0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x04,
        0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x3F, 0x2F,
        0x07, 0x03, 0x03, 0x07, 0x05, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    },
    {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFB, 0xFF, 0xFF,
        0xBF, 0xBF, 0xBF, 0x3F, 0x3E, 0x00, 0x00, 0x00,
        0x00, 0x3F, 0x7C, 0xF8, 0xF0, 0xF0, 0xF8, 0xFC,
        0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x04,
        0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x0F,
        0x0B, 0x03, 0x07, 0x3F, 0x21, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    }
};

static const uint8_t dino_mask_image_data[][24 * 24 / 8] = {
    {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF,
        0xBF, 0xBF, 0xBF, 0x3F, 0x3E, 0x00, 0x00, 0x00,
        0x00, 0x3F, 0x7C, 0xF8, 0xF0, 0xF0, 0xF8, 0xFC,
        0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x04,
        0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x3F, 0x2F,
        0x07, 0x03, 0x07, 0x3F, 0x21, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    },
    {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0xFF, 0x7F,
        0x7F, 0x7F, 0x7F, 0x3F, 0x3E, 0x00, 0x00, 0x00,
        0x00, 0x3F, 0x7C, 0xF8, 0xF0, 0xF0, 0xF8, 0xFC,
        0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x04,
        0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x3F, 0x2F,
        0x07, 0x03, 0x07, 0x3F, 0x21, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    },
    {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF,
        0xBF, 0xBF, 0xBF, 0x3F, 0x3E, 0x00, 0x00, 0x00,
        0x00, 0x3F, 0x7C, 0xF8, 0xF0, 0xF0, 0xF8, 0xFC,
        0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x04,
        0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x3F, 0x2F,
        0x07, 0x03, 0x03, 0x07, 0x05, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    },
    {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF,
        0xBF, 0xBF, 0xBF, 0x3F, 0x3E, 0x00, 0x00, 0x00,
        0x00, 0x3F, 0x7C, 0xF8, 0xF0, 0xF0, 0xF8, 0xFC,
        0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x04,
        0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x0F,
        0x0B, 0x03, 0x07, 0x3F, 0x21, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    }

};

static const image_t dino_images[] = {
    {
        .width = 24,
        .height = 24,
        .data = dino_image_data[0]
    },
    {
        .width = 24,
        .height = 24,
        .data = dino_image_data[1]
    },
    {
        .width = 24,
        .height = 24,
        .data = dino_image_data[2]
    },
    {
        .width = 24,
        .height = 24,
        .data = dino_image_data[3]
    }
};

static const image_t dino_mask_images[] = {
    {
        .width = 24,
        .height = 24,
        .data = dino_mask_image_data[0]
    },
    {
        .width = 24,
        .height = 24,
        .data = dino_mask_image_data[1]
    },
    {
        .width = 24,
        .height = 24,
        .data = dino_mask_image_data[2]
    },
    {
        .width = 24,
        .height = 24,
        .data = dino_mask_image_data[3]
    }
};

void dino_init(dino_t *dino)
{
    dino->images = dino_images;
    dino->mask_images = dino_mask_images;
    dino->state = DINO_NORMAL;
    dino->x = 0;
    dino->y = 0;
    dino->act = 0;
    dino->jump_dir = 0;
    dino->left_or_right = 0;
}

void dino_set_state(dino_t *dino, dino_state_t state)
{
    dino->state = state;
}

dino_state_t dino_get_state(const dino_t *dino)
{
    return dino->state;
}

void dino_set_position(dino_t *dino, int16_t x, int16_t y)
{
    dino->x = x;
    dino->y = y;
}

void dino_get_position(const dino_t *dino, int16_t *x, int16_t *y)
{
    *x = dino->x;
    *y = dino->y;
}

const image_t *dino_get_mask(const dino_t *dino)
{
    return &dino->mask_images[dino->state];
}

void dino_move(dino_t *dino, int16_t dx, int16_t dy)
{
    dino->x += dx;
    dino->y += dy;
}

void dino_update(dino_t *dino)
{
    if (dino->act == 1) {
        if (dino->jump_dir > 0) {
            dino_move(dino, 0, DINO_JUMP_STEP);
            if (dino->y >= DINO_JUMP_HEIGHT) {
                dino->jump_dir = -1;
            }
        } else if (dino->jump_dir < 0) {
            dino_move(dino, 0, -DINO_JUMP_STEP);
            if (dino->y <= 0) {
                dino->jump_dir = 0;
                dino->act = 2;
            }
        }
    } else if (dino->act == 2) {
        dino->state = (dino->left_or_right++ & 0x01) + 2;
        if (dino->x < DINO_RUN_DIST) {
            dino_move(dino, DINO_RUN_STEP, 0);
        }
    }
    image_draw_with_mask(&dino->images[dino->state], dino->x, dino->y, &dino->mask_images[dino->state]);
}

void dino_jump(dino_t *dino)
{
    if (dino->act != 1 && dino->act != 3) {
        dino->act = 1;
        dino->jump_dir = 1;
        dino->state = 0;
    }
}

void dino_over(dino_t *dino)
{
    dino->act = 3;
    dino->state = 1;
}

uint8_t dino_is_dead(dino_t *dino)
{
    return dino->act == 3;
}
